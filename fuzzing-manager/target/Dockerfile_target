FROM ubuntu:18.04
RUN apt-get update -y 
RUN apt-get upgrade -y
RUN apt-get install -y clang wget xxd build-essential python cmake python-pip pkg-config python-yaml libyaml-0-2 libyaml-dev systemd --fix-missing
RUN apt-get install -y git libtool autoconf pkg-config


WORKDIR /fuzzing
RUN mkdir working
WORKDIR /fuzzing/working

RUN wget http://lcamtuf.coredump.cx/afl/releases/afl-2.52b.tgz
RUN  tar xvf afl-2.52b.tgz
RUN rm afl-2.52b.tgz
WORKDIR /fuzzing/working/afl-2.52b
RUN make

#RUN wget https://download.osgeo.org/libtiff/old/tiff-3.7.0.tar.gz
#RUN  tar xvf tiff-3.7.0.tar.gz
#RUN rm tiff-3.7.0.tar.gz
#WORKDIR /fuzzing/working/tiff-3.7.0

WORKDIR /
RUN git clone https://gitlab.gnome.org/GNOME/libxml2.git
WORKDIR /libxml2
RUN git checkout 3e7e75bed2cf2853b0d42d635d36676b3330d475

WORKDIR /fuzzing/working
RUN cp -r /libxml2/ ./libxml2_instrumented

WORKDIR /libxml2
RUN ./autogen.sh
RUN ./configure && make

WORKDIR /fuzzing/working/libxml2_instrumented
RUN ./autogen.sh
RUN CFLAGS="-static -fno-PIE -fno-PIC" CC=/fuzzing/working/afl-2.52b/afl-clang ./configure --enable-shared=no
RUN CFLAGS="-static -fno-PIE -fno-PIC" CC=/fuzzing/working/afl-2.52b/afl-clang make

#RUN make install

#CMD cp /usr/local/bin/tiff2rgba /target
CMD cp -r /libxml2/ /target && cp -r /fuzzing/working/libxml2_instrumented /target


#CMD mkdir /shared/target && cp /usr/local/bin/tiff2rgba /shared/target
